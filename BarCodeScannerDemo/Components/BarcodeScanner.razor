@using BarCodeScannerDemo.Models
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<div class="barcode-scanner-container">
    <div class="scanner-controls mb-3">
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="p-4 mb-4 text-red-800 border border-red-300 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 dark:border-red-800" role="alert">
                <span class="font-medium">Error!</span> @ErrorMessage
            </div>
        }
    </div>

    <div class="scanner-viewport">
        <div id="@ScannerId" class="scanner-element"></div>
        @if (IsScanning)
        {
            <div class="scanner-overlay">
                <div class="scanner-line"></div>
                <p class="scanner-instructions">Point camera at barcode</p>
            </div>
        }
    </div>
</div>

@code {
    private DotNetObjectReference<BarcodeScanner>? dotNetReference;
    private string ScannerId = $"scanner-{Guid.NewGuid():N}";

    [Parameter] public EventCallback<ScannedBarcode> OnBarcodeScanned { get; set; }
    [Parameter] public EventCallback OnScanningStart { get; set; }
    [Parameter] public EventCallback OnScanningStopped { get; set; }

    public bool IsScanning { get; private set; }
    public string? ErrorMessage { get; private set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetReference = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("barcodeScanner.initialize", dotNetReference);
        }
    }

    public async Task StartScanner()
    {
        try
        {
            ErrorMessage = null;
            var success = await JSRuntime.InvokeAsync<bool>("barcodeScanner.start", ScannerId);
            if (!success)
            {
                ErrorMessage = "Scanner is already running";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to start scanner: {ex.Message}";
            StateHasChanged();
        }
    }

    public async Task StopScanner()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("barcodeScanner.stop");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to stop scanner: {ex.Message}";
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnBarcodeDetected(string code, string format)
    {
        var scannedBarcode = new ScannedBarcode
        {
            Code = code,
            Format = format,
            Timestamp = DateTime.Now
        };

        await StopScanner();
        
        StateHasChanged();

        if (OnBarcodeScanned.HasDelegate)
        {
            await OnBarcodeScanned.InvokeAsync(scannedBarcode);
        }

        if (OnScanningStopped.HasDelegate)
        {
            await OnScanningStopped.InvokeAsync();
        }
    }

    [JSInvokable]
    public void OnScannerStarted()
    {
        IsScanning = true;
        ErrorMessage = null;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnScannerStopped()
    {
        IsScanning = false;

        if (OnScanningStopped.HasDelegate)
        {
            await OnScanningStopped.InvokeAsync();
        }
        StateHasChanged();
    }

    [JSInvokable]
    public void OnError(string error)
    {
        ErrorMessage = error;
        IsScanning = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (IsScanning && OnScanningStopped.HasDelegate)
        {
            await StopScanner();
            await OnScanningStopped.InvokeAsync();
        }
        else if (IsScanning)
        {
            await StopScanner();
        }

        dotNetReference?.Dispose();
    }

}